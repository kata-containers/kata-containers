imagePullPolicy: Always

imagePullSecrets: []

image:
  reference: quay.io/kata-containers/kata-deploy
  tag: ""

k8sDistribution: "k8s"  # k8s, k3s, rke2, k0s, microk8s

# Node selector and tolerations to control which nodes the kata-deploy daemonset runs on
# Examples:
# nodeSelector:
#   kata-containers: "enabled"
#   node-type: "worker"
# tolerations:
#   - key: "reservedFor"
#     operator: "Exists"
#     effect: "NoSchedule"
nodeSelector: {}
tolerations: []

# Update strategy for the kata-deploy DaemonSet
# Default is RollingUpdate with maxUnavailable: 1
# Examples:
# updateStrategy:
#   type: OnDelete
# updateStrategy:
#   type: RollingUpdate
#   rollingUpdate:
#     maxUnavailable: 25%
updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 1

debug: false

snapshotter:
  setup: []  # ["nydus", "erofs"] or []

# Shim configuration
# By default (disableAll: false), all shims with enabled: ~ (null) are enabled.
# Set disableAll: true to disable all shims, then explicitly enable specific ones:
#   shims:
#     disableAll: true
#     qemu:
#       enabled: true  # Only qemu is enabled
shims:
  disableAll: false

  clh:
    enabled: ~  # null = use disableAll setting (enabled when false, disabled when true)
    supportedArches:
      - amd64
      - arm64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: ""

  cloud-hypervisor:
    enabled: ~
    supportedArches:
      - amd64
      - arm64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: ""

  dragonball:
    enabled: ~
    supportedArches:
      - amd64
      - arm64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: ""

  fc:
    enabled: ~
    supportedArches:
      - amd64
      - arm64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: "devmapper" # requires pre-configuration on the user side

  qemu:
    enabled: ~
    supportedArches:
      - amd64
      - arm64
      - s390x
      - ppc64le
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: ""

  qemu-runtime-rs:
    enabled: ~
    supportedArches:
      - amd64
      - arm64
      - s390x
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: ""

  qemu-nvidia-gpu:
    enabled: ~
    supportedArches:
      - amd64
      - arm64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: ""

  qemu-nvidia-gpu-snp:
    enabled: ~
    supportedArches:
      - amd64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: ""
      forceGuestPull: true
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  qemu-nvidia-gpu-tdx:
    enabled: ~
    supportedArches:
      - amd64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: ""
      forceGuestPull: true
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  qemu-snp:
    enabled: ~
    supportedArches:
      - amd64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: nydus
      forceGuestPull: false
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  qemu-snp-runtime-rs:
    enabled: ~
    supportedArches:
      - amd64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: nydus
      forceGuestPull: false
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  qemu-tdx:
    enabled: ~
    supportedArches:
      - amd64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: nydus
      forceGuestPull: false
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  qemu-tdx-runtime-rs:
    enabled: ~
    supportedArches:
      - amd64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: nydus
      forceGuestPull: false
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  qemu-se:
    enabled: ~
    supportedArches:
      - s390x
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: nydus
      forceGuestPull: false
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  qemu-se-runtime-rs:
    enabled: ~
    supportedArches:
      - s390x
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: nydus
      forceGuestPull: false
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  qemu-cca:
    enabled: ~
    supportedArches:
      - arm64
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: nydus
      forceGuestPull: false
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  qemu-coco-dev:
    enabled: ~
    supportedArches:
      - amd64
      - s390x
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: nydus
      forceGuestPull: false
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  qemu-coco-dev-runtime-rs:
    enabled: ~
    supportedArches:
      - amd64
      - s390x
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: nydus
      forceGuestPull: false
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

  remote:
    enabled: false
    supportedArches:
      - amd64
      - s390x
    allowedHypervisorAnnotations: []
    containerd:
      snapshotter: "nydus"
    crio:
      guestPull: true
    agent:
      httpsProxy: ""
      noProxy: ""

# Default shim per architecture
defaultShim:
  amd64: qemu
  arm64: qemu
  s390x: qemu
  ppc64le: qemu

runtimeClasses:
  enabled: true
  createDefault: false
  defaultName: "kata"

env:
  installationPrefix: ""
  hostOS: ""
  # Suffix for multi-install deployments to avoid conflicts between multiple Kata installations
  # NOTE: When set, the default RuntimeClass (runtimeClasses.createDefault) will NOT be created
  #       to avoid naming conflicts. Use fully qualified RuntimeClass names (e.g., kata-qemu-suffix1).
  multiInstallSuffix: ""

# Node Feature Discovery (NFD) configuration
# node-feature-discovery is used to detect hardware features, including virtualization support
#
# When enabled, kata-deploy will manage NFD as a subchart and enforce virtualization checks:
#   - x86_64: Requires Intel VT-x (VMX) or AMD-V (SVM) CPU features
#   - aarch64, s390x, ppc64le, riscv64: Always allowed (specific virt detection not yet implemented)
#
# NFD will use its default configuration which includes detecting CPU features like VMX and SVM
#
# IMPORTANT: If you already have node-feature-discovery installed independently in your
#            cluster, keep this disabled.
#
#            When disabled, NO virtualization checks will be enforced (we **DO NOT**
#            control any external node-feature-discovery configuration).
#
#            If you want virtualization checks with an external node-feature-discovery
#            deployment, use nodeSelector manually.
node-feature-discovery:
  enabled: false

# Verification
# Post-install verification to validate Kata Containers is working correctly.
# When a pod spec is provided, runs a verification pod after installation.
#
# Provide your own pod YAML that validates your specific deployment requirements.
#
verification:
  # Namespace where verification pod will be created
  namespace: default

  # Timeout for the verification pod itself to complete (seconds)
  # This is how long to wait for the verification pod to run and finish successfully.
  # Default: 180s (3 minutes)
  timeout: 180

  # Timeout for kata-deploy DaemonSet rollout (seconds)
  # This includes waiting for the kata-deploy image to be pulled from the registry
  # and pods to start. Large images over slow networks may need more time.
  # Default: 1200s (20 minutes)
  daemonsetTimeout: 1200

  # Pod spec for verification (optional)
  # If provided, a verification job will run after install/upgrade.
  # If empty, no verification is performed.
  #
  # Provide your own pod YAML that validates your deployment works correctly.
  # The pod must:
  #   - Have metadata.name set
  #   - Include the correct runtimeClassName (e.g., kata-qemu, kata-qemu-snp)
  #   - Include any annotations needed (e.g., cc_init_data for CoCo)
  #   - Exit 0 on success, non-zero on failure
  #
  # Usage:
  #   helm install kata-deploy ... \
  #     --set-file verification.pod=/path/to/your-verification-pod.yaml
  #
  pod: ""

# Custom Runtimes - bring your own RuntimeClass with base config + drop-in overrides
# Each custom runtime uses an existing Kata config as a base and applies user overrides
# via Kata's config.d drop-in mechanism.
#
# IMPORTANT: The base config is copied AFTER kata-deploy has applied its modifications
# (debug, proxy, annotations). Custom runtimes inherit these settings from their base.
#
# Usage with values file (recommended):
#   Create a custom-runtimes.values.yaml file:
#
#   customRuntimes:
#     enabled: true
#     runtimes:
#       my-gpu-runtime:
#         baseConfig: "qemu-nvidia-gpu"  # Required: existing config to use as base
#         dropIn: |                       # Optional: overrides via config.d mechanism
#           [hypervisor.qemu]
#           default_memory = 1024
#           default_vcpus = 4
#         runtimeClass: |
#           kind: RuntimeClass
#           apiVersion: node.k8s.io/v1
#           metadata:
#             name: kata-my-gpu-runtime
#             labels:
#               app.kubernetes.io/managed-by: kata-deploy
#           handler: kata-my-gpu-runtime
#           overhead:
#             podFixed:
#               memory: "640Mi"
#               cpu: "500m"
#           scheduling:
#             nodeSelector:
#               katacontainers.io/kata-runtime: "true"
#         # Optional: CRI-specific configuration
#         containerd:
#           snapshotter: "nydus"  # Configure containerd snapshotter (nydus, erofs, etc.)
#         crio:
#           pullType: "guest-pull"  # Configure CRI-O runtime_pull_image = true
#
#   Then deploy with:
#     helm install kata-deploy ./kata-deploy -f custom-runtimes.values.yaml
#
# Available base configs: qemu, qemu-nvidia-gpu, qemu-snp, qemu-tdx, cloud-hypervisor, fc, etc.
# The correct shim binary is automatically selected based on the baseConfig.
#
customRuntimes:
  enabled: false
  runtimes: {}
  # Example structure:
  # runtimes:
  #   my-runtime:
  #     baseConfig: "qemu-nvidia-gpu"   # Required: base config name
  #     dropIn: ""                      # Optional: TOML overrides for config.d
  #     runtimeClass: |
  #       <full RuntimeClass YAML>
  #     containerd:
  #       snapshotter: ""  # Optional: nydus, erofs, or empty for default
  #     crio:
  #       pullType: ""  # Optional: guest-pull or empty for default
