apiVersion: v1
kind: ServiceAccount
metadata:
{{- if .Values.env.multiInstallSuffix }}
  name: {{ .Chart.Name }}-sa-{{ .Values.env.multiInstallSuffix }}-cleanup
{{- else }}
  name: {{ .Chart.Name }}-sa-cleanup
{{- end }}
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "-3"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
{{- if .Values.env.multiInstallSuffix }}
  name: {{ .Chart.Name }}-role-{{ .Values.env.multiInstallSuffix }}-cleanup
{{- else }}
  name: {{ .Chart.Name }}-role-cleanup
{{- end }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "-2"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "patch"]
- apiGroups: ["node.k8s.io"]
  resources: ["runtimeclasses"]
  verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]
- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["get", "list"]
- apiGroups: ["nfd.k8s-sigs.io"]
  resources: ["nodefeaturerules"]
  verbs: ["delete", "get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["daemonsets"]
  verbs: ["get", "list", "watch"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
{{- if .Values.env.multiInstallSuffix }}
  name: {{ .Chart.Name }}-rb-{{ .Values.env.multiInstallSuffix }}-cleanup
{{- else }}
  name: {{ .Chart.Name }}-rb-cleanup
{{- end }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
{{- if .Values.env.multiInstallSuffix }}
  name: {{ .Chart.Name }}-role-{{ .Values.env.multiInstallSuffix }}-cleanup
{{- else }}
  name: {{ .Chart.Name }}-role-cleanup
{{- end }}
subjects:
- kind: ServiceAccount
{{- if .Values.env.multiInstallSuffix }}
  name: {{ .Chart.Name }}-sa-{{ .Values.env.multiInstallSuffix }}-cleanup
{{- else }}
  name: {{ .Chart.Name }}-sa-cleanup
{{- end }}
  namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
{{- if .Values.env.multiInstallSuffix }}
  name: {{ .Chart.Name }}-{{ .Values.env.multiInstallSuffix }}-cleanup
{{- else }}
  name: {{ .Chart.Name }}-cleanup
{{- end }}
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        role: cleanup
    spec:
{{- if .Values.env.multiInstallSuffix }}
      serviceAccountName: {{ .Chart.Name }}-sa-{{ .Values.env.multiInstallSuffix }}-cleanup
{{- else }}
      serviceAccountName: {{ .Chart.Name }}-sa-cleanup
{{- end }}
{{- with .Values.nodeSelector }}
      nodeSelector:
{{- toYaml . | nindent 8 }}
{{- end }}
{{- with .Values.tolerations }}
      tolerations:
{{- toYaml . | nindent 8 }}
{{- end }}
      hostPID: true
      containers:
      - name: kube-kata-cleanup
        image: {{ .Values.image.reference }}:{{ default .Chart.AppVersion .Values.image.tag }}
        imagePullPolicy: {{ .Values.imagePullPolicy }}
        command: ["bash", "-c", "/opt/kata-artifacts/scripts/kata-deploy.sh cleanup"]
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: DEBUG
          value: {{ include "kata-deploy.getDebug" . | quote }}
        {{- $shimsAmd64 := include "kata-deploy.getEnabledShimsForArch" (dict "root" . "arch" "amd64") | trim -}}
        {{- if $shimsAmd64 }}
        - name: SHIMS_X86_64
          value: {{ $shimsAmd64 | quote }}
        {{- end }}
        {{- $shimsArm64 := include "kata-deploy.getEnabledShimsForArch" (dict "root" . "arch" "arm64") | trim -}}
        {{- if $shimsArm64 }}
        - name: SHIMS_AARCH64
          value: {{ $shimsArm64 | quote }}
        {{- end }}
        {{- $shimsS390x := include "kata-deploy.getEnabledShimsForArch" (dict "root" . "arch" "s390x") | trim -}}
        {{- if $shimsS390x }}
        - name: SHIMS_S390X
          value: {{ $shimsS390x | quote }}
        {{- end }}
        {{- $shimsPpc64le := include "kata-deploy.getEnabledShimsForArch" (dict "root" . "arch" "ppc64le") | trim -}}
        {{- if $shimsPpc64le }}
        - name: SHIMS_PPC64LE
          value: {{ $shimsPpc64le | quote }}
        {{- end }}
        {{- $defaultShimAmd64 := include "kata-deploy.getDefaultShimForArch" (dict "root" . "arch" "amd64") | trim -}}
        {{- if $defaultShimAmd64 }}
        - name: DEFAULT_SHIM_X86_64
          value: {{ $defaultShimAmd64 | quote }}
        {{- end }}
        {{- $defaultShimArm64 := include "kata-deploy.getDefaultShimForArch" (dict "root" . "arch" "arm64") | trim -}}
        {{- if $defaultShimArm64 }}
        - name: DEFAULT_SHIM_AARCH64
          value: {{ $defaultShimArm64 | quote }}
        {{- end }}
        {{- $defaultShimS390x := include "kata-deploy.getDefaultShimForArch" (dict "root" . "arch" "s390x") | trim -}}
        {{- if $defaultShimS390x }}
        - name: DEFAULT_SHIM_S390X
          value: {{ $defaultShimS390x | quote }}
        {{- end }}
        {{- $defaultShimPpc64le := include "kata-deploy.getDefaultShimForArch" (dict "root" . "arch" "ppc64le") | trim -}}
        {{- if $defaultShimPpc64le }}
        - name: DEFAULT_SHIM_PPC64LE
          value: {{ $defaultShimPpc64le | quote }}
        {{- end }}
        - name: CREATE_RUNTIMECLASSES
          value: {{ .Values.env.createRuntimeClasses | quote }}
        - name: CREATE_DEFAULT_RUNTIMECLASS
          value: {{ .Values.env.createDefaultRuntimeClass | quote }}
        {{- $allowedHypervisorAnnotationsAmd64 := include "kata-deploy.getAllowedHypervisorAnnotationsForArch" (dict "root" . "arch" "amd64") | trim -}}
        {{- if $allowedHypervisorAnnotationsAmd64 }}
        - name: ALLOWED_HYPERVISOR_ANNOTATIONS_X86_64
          value: {{ $allowedHypervisorAnnotationsAmd64 | quote }}
        {{- end }}
        {{- $allowedHypervisorAnnotationsArm64 := include "kata-deploy.getAllowedHypervisorAnnotationsForArch" (dict "root" . "arch" "arm64") | trim -}}
        {{- if $allowedHypervisorAnnotationsArm64 }}
        - name: ALLOWED_HYPERVISOR_ANNOTATIONS_AARCH64
          value: {{ $allowedHypervisorAnnotationsArm64 | quote }}
        {{- end }}
        {{- $allowedHypervisorAnnotationsS390x := include "kata-deploy.getAllowedHypervisorAnnotationsForArch" (dict "root" . "arch" "s390x") | trim -}}
        {{- if $allowedHypervisorAnnotationsS390x }}
        - name: ALLOWED_HYPERVISOR_ANNOTATIONS_S390X
          value: {{ $allowedHypervisorAnnotationsS390x | quote }}
        {{- end }}
        {{- $allowedHypervisorAnnotationsPpc64le := include "kata-deploy.getAllowedHypervisorAnnotationsForArch" (dict "root" . "arch" "ppc64le") | trim -}}
        {{- if $allowedHypervisorAnnotationsPpc64le }}
        - name: ALLOWED_HYPERVISOR_ANNOTATIONS_PPC64LE
          value: {{ $allowedHypervisorAnnotationsPpc64le | quote }}
        {{- end }}
        {{- $snapshotterHandlerMappingAmd64 := include "kata-deploy.getSnapshotterHandlerMappingForArch" (dict "root" . "arch" "amd64") | trim -}}
        {{- if $snapshotterHandlerMappingAmd64 }}
        - name: SNAPSHOTTER_HANDLER_MAPPING_X86_64
          value: {{ $snapshotterHandlerMappingAmd64 | quote }}
        {{- end }}
        {{- $snapshotterHandlerMappingArm64 := include "kata-deploy.getSnapshotterHandlerMappingForArch" (dict "root" . "arch" "arm64") | trim -}}
        {{- if $snapshotterHandlerMappingArm64 }}
        - name: SNAPSHOTTER_HANDLER_MAPPING_AARCH64
          value: {{ $snapshotterHandlerMappingArm64 | quote }}
        {{- end }}
        {{- $snapshotterHandlerMappingS390x := include "kata-deploy.getSnapshotterHandlerMappingForArch" (dict "root" . "arch" "s390x") | trim -}}
        {{- if $snapshotterHandlerMappingS390x }}
        - name: SNAPSHOTTER_HANDLER_MAPPING_S390X
          value: {{ $snapshotterHandlerMappingS390x | quote }}
        {{- end }}
        {{- $snapshotterHandlerMappingPpc64le := include "kata-deploy.getSnapshotterHandlerMappingForArch" (dict "root" . "arch" "ppc64le") | trim -}}
        {{- if $snapshotterHandlerMappingPpc64le }}
        - name: SNAPSHOTTER_HANDLER_MAPPING_PPC64LE
          value: {{ $snapshotterHandlerMappingPpc64le | quote }}
        {{- end }}
        {{- $agentHttpsProxy := include "kata-deploy.getAgentHttpsProxy" . | trim -}}
        {{- if $agentHttpsProxy }}
        - name: AGENT_HTTPS_PROXY
          value: {{ $agentHttpsProxy | quote }}
        {{- end }}
        {{- $agentNoProxy := include "kata-deploy.getAgentNoProxy" . | trim -}}
        {{- if $agentNoProxy }}
        - name: AGENT_NO_PROXY
          value: {{ $agentNoProxy | quote }}
        {{- end }}
        {{- $pullTypeMappingAmd64 := include "kata-deploy.getPullTypeMappingForArch" (dict "root" . "arch" "amd64") | trim -}}
        {{- if $pullTypeMappingAmd64 }}
        - name: PULL_TYPE_MAPPING_X86_64
          value: {{ $pullTypeMappingAmd64 | quote }}
        {{- end }}
        {{- $pullTypeMappingArm64 := include "kata-deploy.getPullTypeMappingForArch" (dict "root" . "arch" "arm64") | trim -}}
        {{- if $pullTypeMappingArm64 }}
        - name: PULL_TYPE_MAPPING_AARCH64
          value: {{ $pullTypeMappingArm64 | quote }}
        {{- end }}
        {{- $pullTypeMappingS390x := include "kata-deploy.getPullTypeMappingForArch" (dict "root" . "arch" "s390x") | trim -}}
        {{- if $pullTypeMappingS390x }}
        - name: PULL_TYPE_MAPPING_S390X
          value: {{ $pullTypeMappingS390x | quote }}
        {{- end }}
        {{- $pullTypeMappingPpc64le := include "kata-deploy.getPullTypeMappingForArch" (dict "root" . "arch" "ppc64le") | trim -}}
        {{- if $pullTypeMappingPpc64le }}
        - name: PULL_TYPE_MAPPING_PPC64LE
          value: {{ $pullTypeMappingPpc64le | quote }}
        {{- end }}
        - name: HELM_POST_DELETE_HOOK
          value: "true"
        - name: INSTALLATION_PREFIX
          value: {{ .Values.env.installationPrefix | quote }}
        - name: MULTI_INSTALL_SUFFIX
          value: {{ .Values.env.multiInstallSuffix | quote }}
        {{- $snapshotterSetup := include "kata-deploy.getSnapshotterSetup" . | trim -}}
        {{- if $snapshotterSetup }}
        - name: EXPERIMENTAL_SETUP_SNAPSHOTTER
          value: {{ $snapshotterSetup | quote }}
        {{- end }}
        {{- $forceGuestPullAmd64 := include "kata-deploy.getForceGuestPullForArch" (dict "root" . "arch" "amd64") | trim -}}
        {{- if $forceGuestPullAmd64 }}
        - name: EXPERIMENTAL_FORCE_GUEST_PULL_X86_64
          value: {{ $forceGuestPullAmd64 | quote }}
        {{- end }}
        {{- $forceGuestPullArm64 := include "kata-deploy.getForceGuestPullForArch" (dict "root" . "arch" "arm64") | trim -}}
        {{- if $forceGuestPullArm64 }}
        - name: EXPERIMENTAL_FORCE_GUEST_PULL_AARCH64
          value: {{ $forceGuestPullArm64 | quote }}
        {{- end }}
        {{- $forceGuestPullS390x := include "kata-deploy.getForceGuestPullForArch" (dict "root" . "arch" "s390x") | trim -}}
        {{- if $forceGuestPullS390x }}
        - name: EXPERIMENTAL_FORCE_GUEST_PULL_S390X
          value: {{ $forceGuestPullS390x | quote }}
        {{- end }}
        {{- $forceGuestPullPpc64le := include "kata-deploy.getForceGuestPullForArch" (dict "root" . "arch" "ppc64le") | trim -}}
        {{- if $forceGuestPullPpc64le }}
        - name: EXPERIMENTAL_FORCE_GUEST_PULL_PPC64LE
          value: {{ $forceGuestPullPpc64le | quote }}
        {{- end }}
{{- with .Values.env.hostOS }}
        - name: HOST_OS
          value: {{ . | quote }}
{{- end }}
        securityContext:
          privileged: true
        volumeMounts:
        - name: crio-conf
          mountPath: /etc/crio/
        - name: containerd-conf
          mountPath: /etc/containerd/
        - name: host
          mountPath: /host/
      volumes:
      - name: crio-conf
        hostPath:
          path: /etc/crio/
      - name: containerd-conf
        hostPath:
          path: '{{- template "containerdConfPath" .Values }}'
      - name: host
        hostPath:
          path: /
      restartPolicy: Never 
