#
# Copyright (c) 2025 Microsoft Corporation
#
# SPDX-License-Identifier: Apache-2.0
#
apiVersion: v1
kind: Pod
metadata:
  name: openvpn-init-secrets
spec:
  initContainers:
  - name: openvpn-init
    image: alpine:3.19
    command: ["/bin/sh", "-c"]
    args:
      - |
        set -e
        for i in 1 2 3; do apk add --no-cache openvpn easy-rsa openssl && break || sleep 3; done

        WORKDIR="/etc/openvpn"
        CLIENT_NAME="client1"
        cd "$WORKDIR"

        export EASYRSA="/usr/share/easy-rsa"
        export EASYRSA_PKI="$WORKDIR/pki"
        export EASYRSA_BATCH=1
        export RANDFILE=/dev/urandom

        $EASYRSA/easyrsa init-pki
        $EASYRSA/easyrsa build-ca nopass
        $EASYRSA/easyrsa gen-req server nopass
        $EASYRSA/easyrsa sign-req server server
        $EASYRSA/easyrsa gen-req $CLIENT_NAME nopass
        $EASYRSA/easyrsa sign-req client $CLIENT_NAME
        $EASYRSA/easyrsa gen-dh
        #TODO the gen-dh command seems to hang in CI (for some tasks?), but works locally.
        # Triggered in CI, the task doesn't even show progress.
        # I tried various things centered around entropy, but no success so far.
        #openssl dhparam -out "$WORKDIR/pki/dh.pem" 2048 -rand /dev/urandom

        base64 "$WORKDIR/pki/ca.crt" > "$WORKDIR/ca.crt.b64"
        base64 "$WORKDIR/pki/issued/${CLIENT_NAME}.crt" > "$WORKDIR/client.crt.b64"
        base64 "$WORKDIR/pki/private/${CLIENT_NAME}.key" > "$WORKDIR/client.key.b64"
        base64 "$WORKDIR/pki/issued/server.crt" > "$WORKDIR/server.crt.b64"
        base64 "$WORKDIR/pki/private/server.key" > "$WORKDIR/server.key.b64"
        base64 "$WORKDIR/pki/dh.pem" > "$WORKDIR/dh.pem.b64"
    volumeMounts:
    - name: openvpn-data
      mountPath: /etc/openvpn
  containers:
  - name: keepalive
    image: quay.io/prometheus/busybox:latest
    command: ["sleep", "infinity"]
    volumeMounts:
    - name: openvpn-data
      mountPath: /etc/openvpn
  volumes:
  - name: openvpn-data
    emptyDir: {}
