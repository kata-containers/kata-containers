#
# Copyright (c) 2025 Microsoft Corporation
#
# SPDX-License-Identifier: Apache-2.0
#
apiVersion: v1
kind: Pod
metadata:
  name: openvpn-client
  labels:
    app: openvpn-client
spec:
  containers:
  - name: openvpn-client
    image: alpine:3.19
    command:
    - /bin/sh
    - -c
    - |
      for i in 1 2 3; do apk add --no-cache openvpn && break || sleep 3; done
      openvpn --config /vpn/client.ovpn
    securityContext:
      privileged: false
      capabilities:
        add:
          - NET_ADMIN
    volumeMounts:
    - name: openvpn-config
      mountPath: /vpn
    - name: openvpn-secrets
      mountPath: /vpn/keys
      readOnly: true
    - name: dev-net-tun
      mountPath: /dev/net/tun
    env:
    - name: VPN_CONFIG
      value: "/vpn/client.ovpn"
    readinessProbe:
      exec:
        command:
        - /bin/sh
        - -c
        - "ip a | grep tap0"
      initialDelaySeconds: 10
      periodSeconds: 5
      failureThreshold: 3
  volumes:
  - name: openvpn-config
    configMap:
      name: openvpn-client-config
  - name: openvpn-secrets
    secret:
      secretName: openvpn-client-secrets
  - name: dev-net-tun
    hostPath:
      path: /dev/net/tun
      type: CharDevice
  runtimeClassName: kata
---

apiVersion: v1
kind: ConfigMap
metadata:
  name: openvpn-client-config
  labels:
    app: openvpn-client
data:
  client.ovpn: |
    client
    dev tap
    proto udp
    remote openvpn-server 1194
    resolv-retry infinite
    nobind
    persist-key
    persist-tun
    ca /vpn/keys/ca.crt
    cert /vpn/keys/client.crt
    key /vpn/keys/client.key
    remote-cert-tls server
    cipher AES-256-GCM
    verb 3
---

apiVersion: v1
kind: Secret
metadata:
  name: openvpn-client-secrets
  labels:
    app: openvpn-client
  annotations:
    description: "Contains OpenVPN client certificates and keys"
type: Opaque
data:
  ca.crt: $BASE64_CA_CRT
  client.crt: $BASE64_CLIENT_CRT
  client.key: $BASE64_CLIENT_KEY
