#
# Copyright (c) 2025 Microsoft Corporation
# Copyright (c) 2025 NVIDIA Corporation
#
# SPDX-License-Identifier: Apache-2.0
#
apiVersion: v1
kind: Pod
metadata:
  name: openvpn-init-secrets
spec:
  initContainers:
  - name: openvpn-init
    image: quay.io/kata-containers/alpine:3.22.1-openvpn
    command: ["/bin/sh", "-c"]
    args:
      - |
        set -e
        WORKDIR="/etc/openvpn"
        CLIENT_NAME="client1"
        cd "$WORKDIR"

        export EASYRSA="/usr/share/easy-rsa"
        export EASYRSA_PKI="$WORKDIR/pki"
        export EASYRSA_BATCH=1
        export EASYRSA_ALGO=ec
        export EASYRSA_CURVE=secp384r1

        $EASYRSA/easyrsa init-pki
        $EASYRSA/easyrsa build-ca nopass
        $EASYRSA/easyrsa gen-req server nopass
        $EASYRSA/easyrsa sign-req server server
        $EASYRSA/easyrsa gen-req $CLIENT_NAME nopass
        $EASYRSA/easyrsa sign-req client $CLIENT_NAME

        base64 "$WORKDIR/pki/ca.crt" > "$WORKDIR/ca.crt.b64"
        base64 "$WORKDIR/pki/issued/${CLIENT_NAME}.crt" > "$WORKDIR/client.crt.b64"
        base64 "$WORKDIR/pki/private/${CLIENT_NAME}.key" > "$WORKDIR/client.key.b64"
        base64 "$WORKDIR/pki/issued/server.crt" > "$WORKDIR/server.crt.b64"
        base64 "$WORKDIR/pki/private/server.key" > "$WORKDIR/server.key.b64"
    volumeMounts:
    - name: openvpn-data
      mountPath: /etc/openvpn
  containers:
  - name: keepalive
    image: quay.io/prometheus/busybox:latest
    command: ["sleep", "infinity"]
    volumeMounts:
    - name: openvpn-data
      mountPath: /etc/openvpn
  volumes:
  - name: openvpn-data
    emptyDir: {}
