# Kata Agent

## Overview

The Kata agent is a long running process that runs inside the Virtual Machine
(VM) (also known as the "pod" or "sandbox").

The agent is packaged inside the Kata Containers
[guest image](../../docs/design/architecture/README.md#guest-image)
which is used to boot the VM. Once the runtime has launched the configured
[hypervisor](../../docs/hypervisors.md) to create a new VM, the agent is
started. From this point on, the agent is responsible for creating and
managing the life cycle of the containers inside the VM.

For further details, see the
[architecture document](../../docs/design/architecture).

## Audience

If you simply wish to use Kata Containers, it is not necessary to understand
the details of how the agent operates. Please see the
[installation documentation](../../docs/install) for details of how deploy
Kata Containers (which will include the Kata agent).

The remainder of this document is only useful for developers and testers.

## Build from Source

Since the agent is written in the Rust language this section assumes the tool
chain has been installed using standard Rust `rustup` tool.

### Build with musl

If you wish to build the agent with the `musl` C library, you need to run the
following commands:

```bash
$ arch=$(uname -m)
$ rustup target add "${arch}-unknown-linux-musl"
$ sudo ln -s /usr/bin/g++ /bin/musl-g++
```

> **Note:**
>
> It is not currently possible to build using `musl` on ppc64le and s390x
> since both platforms lack the `musl` target.

### Build the agent binary

The following steps download the Kata Containers source files and build the agent:

```bash
$ GOPATH="${GOPATH:-$HOME/go}"
$ dir="$GOPATH/src/github.com/kata-containers"
$ git -C ${dir} clone --depth 1 https://github.com/kata-containers/kata-containers
$ make -C ${dir}/kata-containers/src/agent
```

## Change the agent API

The Kata runtime communicates with the Kata agent using a ttRPC based API protocol.

This ttRPC API is defined by a set of [protocol buffers files](../libs/protocols/protos).
The protocol files are used to generate the bindings for the following components:

| Component | Language | Generation method `[*]` | Tooling required |
|-|-|-|-|
| runtime | Golang | Run, `make generate-protocols` | `protoc` |
| agent | Rust | Run, `make` |  |

> **Key:**
>
> `[*]` - All commands must be run in the agent repository.

If you wish to change the API, these files must be regenerated. Although the
rust code will be automatically generated by the
[build script](../libs/protocols/build.rs),
the Golang code generation requires the external `protoc` command to be
available in `$PATH`.

To install the `protoc` command on a Fedora/CentOS/RHEL system:

```bash
$ sudo dnf install -y protobuf-compiler
```

## Configuring the agent

The agent can be configured in a couple of ways.

If running under the supervision of the Kata runtime, the agent will be automatically configured according to some properties in the runtime's `configuration.toml` file (see [runtime configuration](../runtime/README.md#configuration)). For example, the `enable_debug` option under the `[agent.kata]` section can be used to set debug-level logs. However, not all the accepted configurations are mapped into `configuration.toml`, so any additional options should be passed directly to the agent via kernel parameters.

Any kernel parameter is be specified in the `kernel_params` property in the runtime's `configuration.toml`. As an example, to enable the Agent support for unified cgroup hierarchy and set debug logs, write the following line in `configuration.toml`:

```
kernel_params = "agent.unified_cgroup_hierarchy=true agent.log=debug"
```

The agent options passed via kernel parameters have the `agent.OPTION` format, where `OPTION` can be:

| Option | Description | Example |
|-|-|-|
|`debug_console`|Enable debug console|`agent.debug_console`|
|`devmode`|Enable `devmode`|`agent.devmode`|
|`trace`|Enable agent [tracing](#tracing)|`agent.trace`|
|`log`|Set the log level. Accepted values are: fatal, panic, critical, error, warn, info (default), debug, trace.|`agent.log=debug`|
|`server_addr`|Set the ttRPC server address. The default value is `vsock://-1:1024`|`agent.server_address=unix:///path/to/server.socket`|
|`hotplug_timeout`|Set the hotplug timeout in seconds. The default value is 3.|`agent.hotplug_timeout=10`|
|`debug_console_vport`|Set the debug console `vsock` port. Used when debugging for Cloud Hypervisor and Firecracker hypervisors. The default value is 0.|`agent.debug_console_vport=1026`|
|`log_vport`|Set the `vsock` log port. The default value is 0.|`agent.log_vport=5555`|
|`container_pipe_size`|Set the container pipe size. The default size is 0.|`agent.container_pipe_size=1024`|
|`unified_cgroup_hierarchy`|Whether to use unified cgroup hierarchy or not. Accepted values are: true, false (default)|`agent.unified_cgroup_hierarchy=true`|

Alternatively those options can be defined in a configuration file (see a sample file [here](samples/configuration-all-endpoints.toml)) and then passed via `agent.config_file` kernel parameter (note that the file must be in the guest's filesystem). Or if the agent is running in [stand alone](#run-the-agent-stand-alone) mode, you can pass the file's path via `--config` parameter.

Some use cases may require that the agent's API have endpoints blocked (all are allowed by default). If you have such as requirement then you can define a list of only allowed endpoints in the agent configuration file, by writing the list in the `allowed` property under the `[endpoints]` section. See in the sample file [here](samples/configuration-all-endpoints.toml) as an example.

The `KATA_AGENT_SERVER_ADDR`, `KATA_AGENT_LOG_LEVEL`, and `KATA_AGENT_TRACING` environment variables are also recognized by the agent process. They are equivalent to the `agent.server_addr`, `agent.log`, and `agent.trace` options respectively.

## Custom guest image and kernel assets

If you wish to develop or test changes to the agent, you will need to create a
custom guest image using the [osbuilder tool](../../tools/osbuilder). You
may also wish to create a custom [guest kernel](../../tools/packaging/kernel).

Once created, [configure](../runtime/README.md#configuration) Kata Containers to use
these custom assets to allow you to test your changes.

> **Note:**
>
> To simplify development and testing, you may wish to run the agent
> [stand alone](#run-the-agent-stand-alone) initially.

## Tracing

For details of tracing the operation of the agent, see the
[tracing documentation](/docs/tracing.md).

## Run the agent stand alone

Although the agent is designed to run in a VM environment, for development and
testing purposes it is possible to run it as a normal application.

When run in this way, the agent can be controlled using the low-level Kata
agent control tool, rather than the Kata runtime.

For further details, see the
[agent control tool documentation](../tools/agent-ctl/README.md#run-the-tool-and-the-agent-in-the-same-environment).
