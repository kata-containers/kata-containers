on:
  issue_comment:
    types: [created, edited]

name: test-kata-deploy

jobs:
  create-and-test-container:
    if: |
      github.event.issue.pull_request
      && github.event_name == 'issue_comment'
      && github.event.action == 'created'
      && startsWith(github.event.comment.body, '/test_kata_deploy')
    runs-on: ubuntu-latest
    steps:
      - name: get-PR-ref
        id: get-PR-ref
        run: |
            ref=$(cat $GITHUB_EVENT_PATH | jq -r '.issue.pull_request.url' | sed  's#^.*\/pulls#refs\/pull#' | sed 's#$#\/merge#')
            echo "reference for PR: " ${ref}
            echo "##[set-output name=pr-ref;]${ref}"

      - name: check out
        uses: actions/checkout@v2
        with:
           ref: ${{ steps.get-PR-ref.outputs.pr-ref }}

      - name: test-kata-deploy-ci-in-aks
        uses: ./tools/packaging/kata-deploy/action
        with:
          packaging-sha: c9e6efb1e101716615873ea2a5641ca56397e0ca
        env:
          PKG_SHA: c9e6efb1e101716615873ea2a5641ca56397e0ca
          AZ_APPID: ${{ secrets.AZ_APPID }}
          AZ_PASSWORD: ${{ secrets.AZ_PASSWORD }}
          AZ_SUBSCRIPTION_ID: ${{ secrets.AZ_SUBSCRIPTION_ID }}
          AZ_TENANT_ID: ${{ secrets.AZ_TENANT_ID }}
