name: nydus-snapshotter-version-sync

on:
  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  nydus-snapshotter-version-check:
    name: nydus-snapshotter-version-check
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        persist-credentials: false
    - name: Ensure nydus-snapshotter-version is in sync inside our repo
      run: |
        dockerfile_version=$(grep "ARG NYDUS_SNAPSHOTTER_VERSION" tools/packaging/kata-deploy/Dockerfile | cut -f2 -d'=')
        versions_version=$(yq ".externals.nydus-snapshotter.version | explode(.)" versions.yaml)
        if [[ "${dockerfile_version}" != "${versions_version}" ]]; then
          echo "nydus-snapshotter version must be the same in the following places: "
          echo "- versions.yaml: ${versions_version}"
          echo "- tools/packaging/kata-deploy/Dockerfile: ${dockerfile_version}"
          exit 1
        fi
