name: Run the Kata Containers CI
on:
  workflow_call:
    inputs:
      commit-hash:
        required: true
        type: string
      pr-number:
        required: true
        type: string
      tag:
        required: true
        type: string
      target-branch:
        required: false
        type: string
        default: ""

jobs:
  build-and-publish-kata-deploy-helm-chart:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout kata-containers
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit-hash }}
          fetch-depth: 0
          path: kata-containers

      - name: Checkout helm-charts
        uses: actions/checkout@v4
        with:
          repository: "zvonkok/helm-charts"
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          path: helm-charts

      - name: Rebase atop of the latest target branch
        run: |
          ./kata-containers/tests/git-helper.sh "rebase-atop-of-the-latest-target-branch" kata-containers
        env:
          TARGET_BRANCH: ${{ inputs.target-branch }}

      - name: Rebase atop of the latest target branch
        run: |
          ./kata-containers/tests/git-helper.sh "rebase-atop-of-the-latest-target-branch" helm-charts
        env:
          TARGET_BRANCH: main

      - name: Set up Helm
        uses: azure/setup-helm@v1
        with:
          version: v3.15.2

      - name: Helm lint
        run: |
          helm lint ./kata-containers/tools/packaging/kata-deploy/helm-chart/kata-deploy

      - name: Helm package/index
        run: |
          helm package ./kata-containers/tools/packaging/kata-deploy/helm-chart/kata-deploy -d ./helm-charts/
          helm repo index ./helm-charts/ --merge ./helm-charts/index.yaml --url https://zvonkok.github.io/helm-charts/

      - name: Commit and push changes
        uses: actions/checkout@v4
      - run: |
          cd ./helm-charts
          git commit -am "Update Kata Deploy Helm Chart"
          git push




  # build-kata-static-tarball-amd64-nvidia-gpu:
  #   uses: ./.github/workflows/build-kata-static-tarball-amd64-nvidia-gpu.yaml
  #   with:
  #     tarball-suffix: -${{ inputs.tag }}
  #     commit-hash: ${{ inputs.commit-hash }}
  #     target-branch: ${{ inputs.target-branch }}

  # publish-kata-deploy-payload-amd64-nvidia-gpu:
  #   needs: build-kata-static-tarball-amd64-nvidia-gpu
  #   uses: ./.github/workflows/publish-kata-deploy-payload-amd64-nvidia-gpu.yaml
  #   with:
  #     tarball-suffix: -${{ inputs.tag }}
  #     registry: ghcr.io
  #     repo: ${{ github.repository_owner }}/kata-deploy-ci
  #     tag: ${{ inputs.tag }}-amd64
  #     commit-hash: ${{ inputs.commit-hash }}
  #     target-branch: ${{ inputs.target-branch }}
  #   secrets: inherit

  # build-kata-static-tarball-arm64-nvidia-gpu:
  #   uses: ./.github/workflows/build-kata-static-tarball-arm4-nvidia-gpu.yaml
  #   with:
  #     tarball-suffix: -${{ inputs.tag }}
  #     commit-hash: ${{ inputs.commit-hash }}
  #     target-branch: ${{ inputs.target-branch }}

  # publish-kata-deploy-payload-arm64-nvidia-gpu:
  #   needs: build-kata-static-tarball-arm64-nvidia-gpu
  #   uses: ./.github/workflows/publish-kata-deploy-payload-arm64-nvidia-gpu.yaml
  #   with:
  #     tarball-suffix: -${{ inputs.tag }}
  #     registry: ghcr.io
  #     repo: ${{ github.repository_owner }}/kata-deploy-ci
  #     tag: ${{ inputs.tag }}-amd64
  #     commit-hash: ${{ inputs.commit-hash }}
  #     target-branch: ${{ inputs.target-branch }}
  #   secrets: inherit
