# Copyright (c) 2019 Ant Financial
#
# SPDX-License-Identifier: Apache-2.0
#

dist: bionic
os: linux

language: rust

# set cache directories manually, because
# we are using a non-standard directory struct
# cargo root is in srs/agent
cache:
  directories:
    - $TRAVIS_HOME/.cache/sccache
    - $TRAVIS_HOME/.cargo/
    - $TRAVIS_HOME/.rustup/
    - src/agent/target
rust:
  - 1.44.1

env: target_branch=$TRAVIS_BRANCH

before_install:
  - git remote set-branches --add origin "${TRAVIS_BRANCH}"
  - git fetch
  - "ci/setup.sh"

# we use install to run check agent
# so that it is easy to skip for non-amd64 platform
install:
  # - rustup target add x86_64-unknown-linux-musl
  # - sudo ln -sf /usr/bin/g++ /bin/musl-g++
  # - rustup component add rustfmt
  - "ci/install_go.sh"
  - "ci/install_rust.sh"
  - export PATH=$PATH:"$HOME/.cargo/bin"
  - export RUST_AGENT=yes
  - rustfmt --version
  - find . -type f -name "*.rs"  | egrep -v "target/|grpc-rs/|protocols/" | xargs ls -l
  - find . -type f -name "*.rs"  | egrep -v "target/|grpc-rs/|protocols/" | xargs rustfmt --check
  - "ci/static-checks.sh"

before_script:
  - make -C ${TRAVIS_BUILD_DIR}/src/runtime
  - make -C ${TRAVIS_BUILD_DIR}/src/runtime test
  - sudo -E PATH=$PATH GOPATH=$GOPATH make -C ${TRAVIS_BUILD_DIR}/src/runtime test

script:
  - make -C ${TRAVIS_BUILD_DIR}/src/agent
  - make -C ${TRAVIS_BUILD_DIR}/src/agent check
  - sudo -E PATH=$PATH make -C ${TRAVIS_BUILD_DIR}/src/agent check

jobs:
  include:
  - name: x86_64 test
    os: linux
  - name: ppc64le test
    os: linux-ppc64le
    install: skip
  allow_failures:
    - name: ppc64le test
  fast_finish: true
